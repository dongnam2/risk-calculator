<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />

  <!-- iPhone í™ˆí™”ë©´ ì›¹ì•± ìµœì í™” -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="3STEP CALC">
  <meta name="theme-color" content="#0f172a">
  <!-- (ì„ íƒ) icon-180.pngë¥¼ ê°™ì€ í´ë”(ë£¨íŠ¸)ì— ì˜¬ë¦¬ë©´ ì•„ì´ì½˜ ì ìš© -->
  <link rel="apple-touch-icon" href="icon-180.png">

  <title>3ë¶„í•  ë¦¬ìŠ¤í¬ ê³„ì‚°ê¸° PRO</title>

  <style>
    :root { --main-color: #00eaff; --bg-color: #0f172a; --card-bg: #1e293b; --accent: #fbbf24; }

    /* iOS ê¸€ì ìë™í™•ëŒ€/ë ˆì´ì•„ì›ƒ íŠ ë°©ì§€ */
    html { -webkit-text-size-adjust: 100%; }

    body {
      font-family: -apple-system, sans-serif;
      background-color: var(--bg-color);
      color: white;
      margin: 0;
      padding: 20px;
      display: flex;
      justify-content: center;
      padding-top: calc(20px + env(safe-area-inset-top));
      padding-bottom: calc(20px + env(safe-area-inset-bottom));
    }

    .container {
      width: 100%;
      max-width: 450px;
      background: var(--card-bg);
      padding: 25px;
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }

    h2 {
      text-align: center;
      color: var(--main-color);
      margin-bottom: 20px;
      font-weight: 800;
      letter-spacing: -1px;
    }

    .section-title {
      font-size: 14px;
      color: var(--main-color);
      margin-bottom: 10px;
      font-weight: bold;
      border-left: 4px solid var(--main-color);
      padding-left: 8px;
    }

    .input-group { margin-bottom: 12px; }

    label {
      display: block;
      margin-bottom: 5px;
      font-size: 12px;
      color: #94a3b8;
    }

    /* í•µì‹¬: iOS ìë™ ì¤Œ ë°©ì§€ -> input/textarea 16px ì´ìƒ */
    input, textarea {
      width: 100%;
      padding: 12px;
      box-sizing: border-box;
      border-radius: 10px;
      border: 1px solid #334155;
      background: #0f172a;
      color: white;
      font-size: 16px;
      outline: none;
    }
    input:focus, textarea:focus { border-color: var(--main-color); }

    /* ê³ ì •ê°’(ì ê¸ˆ) input ì‹œê° ì²˜ë¦¬ */
    input[readonly] {
      opacity: 0.85;
      border-style: dashed;
      cursor: default;
    }

    .entry-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 8px;
      margin-bottom: 15px;
    }

    button {
      width: 100%;
      padding: 16px;
      border: none;
      border-radius: 12px;
      background: var(--main-color);
      color: #0f172a;
      font-weight: bold;
      font-size: 17px;
      cursor: pointer;
      margin-top: 10px;
    }

    .result {
      margin-top: 25px;
      padding: 20px;
      background: #334155;
      border-radius: 12px;
      display: none;
    }

    .res-header {
      font-size: 16px;
      font-weight: bold;
      margin-bottom: 15px;
      text-align: center;
      color: #f8fafc;
      border-bottom: 1px solid #475569;
      padding-bottom: 10px;
    }

    .res-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      font-size: 14px;
      gap: 10px;
    }

    .res-val {
      font-weight: bold;
      color: var(--main-color);
      text-align: right;
      white-space: nowrap;
    }

    .highlight-box {
      background: #1e293b;
      padding: 12px;
      border-radius: 8px;
      margin-top: 10px;
      border-left: 4px solid var(--accent);
    }

    .split-title {
      font-size: 13px;
      font-weight: bold;
      color: var(--accent);
      margin-bottom: 8px;
    }

    .warning {
      color: #ff4444;
      font-size: 11px;
      text-align: center;
      margin-top: 15px;
      line-height: 1.4;
    }

    /* ===== íƒ­-ë³µì‚¬ìš© UI ===== */
    .copyable {
      cursor: pointer;
      position: relative;
      padding: 2px 6px;
      border-radius: 8px;
      border: 1px dashed rgba(148,163,184,0.35);
      user-select: none;
      -webkit-user-select: none;
    }
    .copyable:active { transform: scale(0.98); }

    /* ì§„ì…ê°€/ì†ì ˆê°€ ì¹© */
    .copychip{
      display:inline-flex;
      align-items:center;
      padding:8px 10px;
      border-radius:999px;
      border:1px dashed rgba(148,163,184,0.35);
      background:#0f172a;
      font-size:14px;
    }
    .copychip:active{ transform: scale(0.98); }

    /* í† ìŠ¤íŠ¸ */
    #miniToast {
      position: fixed;
      left: 50%;
      bottom: calc(18px + env(safe-area-inset-bottom));
      transform: translateX(-50%);
      background: rgba(15, 23, 42, 0.92);
      border: 1px solid rgba(148,163,184,0.25);
      color: #e2e8f0;
      padding: 10px 14px;
      border-radius: 999px;
      font-size: 13px;
      z-index: 9999;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
    }
    #miniToast.show { opacity: 1; }
  </style>
</head>

<body>
  <div class="container">
    <h2>3-STEP POSITION CALC</h2>

    <div class="section-title">ê¸°ë³¸ ì •ë³´ (ì†ì‹¤ 2% ê³ ì •)</div>
    <div class="entry-grid" style="grid-template-columns: 1fr 1fr;">
      <div class="input-group">
        <label>ì´ ì‹œë“œ (USDT) - ê³ ì •</label>
        <input type="number" id="seed" value="2000" readonly inputmode="decimal" autocomplete="off" autocapitalize="off" spellcheck="false">
      </div>
      <div class="input-group">
        <label>ë ˆë²„ë¦¬ì§€ (ë°°) - ê³ ì •</label>
        <input type="number" id="leverage" value="100" readonly inputmode="decimal" autocomplete="off" autocapitalize="off" spellcheck="false">
      </div>
    </div>

    <div class="section-title">ì§„ì… ê°€ê²© (1~3ì°¨)</div>
    <div class="entry-grid">
      <div class="input-group">
        <label>1ì°¨ ì§„ì…</label>
        <input type="number" id="e1" placeholder="í•„ìˆ˜" inputmode="decimal" autocomplete="off" autocapitalize="off" spellcheck="false">
      </div>
      <div class="input-group">
        <label>2ì°¨ ì§„ì…</label>
        <input type="number" id="e2" placeholder="ì„ íƒ" inputmode="decimal" autocomplete="off" autocapitalize="off" spellcheck="false">
      </div>
      <div class="input-group">
        <label>3ì°¨ ì§„ì…</label>
        <input type="number" id="e3" placeholder="ì„ íƒ" inputmode="decimal" autocomplete="off" autocapitalize="off" spellcheck="false">
      </div>
    </div>

    <div class="input-group">
      <div class="section-title">ì†ì ˆ ê°€ê²© (Stop Loss)</div>
      <input type="number" id="stop" placeholder="ì†ì ˆê°€ ì…ë ¥" inputmode="decimal" autocomplete="off" autocapitalize="off" spellcheck="false">
    </div>

    <button type="button" onclick="calculate()">í¬ì§€ì…˜ ìƒì„¸ ê³„ì‚°</button>

    <div class="result" id="resultArea">
      <div class="res-header">ğŸ“Š ì „ì²´ í¬ì§€ì…˜ ìš”ì•½</div>

      <!-- ì§„ì…ê°€/ì†ì ˆê°€ ì¹©: ê°ê° íƒ­ ë³µì‚¬ -->
      <div class="highlight-box" style="margin-top:12px;">
        <div class="split-title">ì§„ì…ê°€ / ì†ì ˆê°€ (íƒ­í•˜ë©´ ìˆ«ì ë³µì‚¬)</div>
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <div class="res-val copychip" id="chipE1">E1: -</div>
          <div class="res-val copychip" id="chipE2">E2: -</div>
          <div class="res-val copychip" id="chipE3">E3: -</div>
          <div class="res-val copychip" id="chipStop">STOP: -</div>
        </div>
      </div>

      <div class="res-row" style="margin-top:14px;">
        <span>ê°ìˆ˜í•  ì†ì‹¤ (2%)</span>
        <span class="res-val" id="resRisk" style="color:#ef4444;">0</span>
      </div>

      <div class="res-row">
        <span>í‰ê·  ì§„ì… ë‹¨ê°€</span>
        <span class="res-val" id="resAvgEntry">0</span>
      </div>

      <div class="res-row" style="background:#2d3748; padding:5px; border-radius:4px;">
        <span>ì´ í¬ì§€ì…˜ ì‚¬ì´ì¦ˆ</span>
        <span class="res-val" id="resTotalSize" style="color:#00ff88;">0</span>
      </div>

      <div class="res-row">
        <span>ì´ ì½”ì¸ ìˆ˜ëŸ‰</span>
        <span class="res-val" id="resTotalQty">0</span>
      </div>

      <div class="res-row">
        <span>ì´ íˆ¬ì… ì¦ê±°ê¸ˆ(Margin)</span>
        <span class="res-val" id="resTotalMargin" style="color:var(--accent);">0</span>
      </div>

      <div class="highlight-box">
        <div class="split-title" id="splitCountText">íšŒì°¨ë³„ ì§„ì… ê°€ì´ë“œ (ê· ë“±)</div>
        <div class="res-row">
          <span>íšŒì°¨ë³„ ì½”ì¸ ìˆ˜ëŸ‰</span>
          <span class="res-val" id="resPerQty">0</span>
        </div>
        <div class="res-row">
          <span>íšŒì°¨ë³„ í¬ì§€ì…˜(USDT)</span>
          <span class="res-val" id="resPerSize">0</span>
        </div>
        <div class="res-row">
          <span>íšŒì°¨ë³„ ì¦ê±°ê¸ˆ(USDT)</span>
          <span class="res-val" id="resPerMargin">0</span>
        </div>
      </div>

      <!-- í…”ë ˆê·¸ë¨ ë³µì‚¬ìš© -->
      <div class="highlight-box" style="margin-top:14px;">
        <div class="split-title">ğŸ“‹ í…”ë ˆê·¸ë¨ ë³µì‚¬ìš© í…ìŠ¤íŠ¸</div>
        <textarea id="copyText" readonly rows="7" placeholder="ê³„ì‚° í›„ ìë™ ìƒì„±ë©ë‹ˆë‹¤."
          autocomplete="off" autocapitalize="off" spellcheck="false"
          style="line-height:1.35; resize:none;"></textarea>

        <button type="button" onclick="copyTelegramText()" style="margin-top:10px;">
          í…”ë ˆê·¸ë¨ìš© ì „ì²´ ë³µì‚¬
        </button>

        <div id="copyStatus" style="margin-top:8px; font-size:12px; color:#94a3b8; text-align:center;"></div>
      </div>

      <div class="warning">
        â€» 50~100ë°° ê³ ë°°ìœ¨ ì‚¬ìš© ì‹œ ìŠ¬ë¦¬í”¼ì§€ì— ì£¼ì˜í•˜ì„¸ìš”.<br>
        ê³„ì‚°ëœ ìˆ˜ëŸ‰ì€ ì†ì ˆ ì‹œ ì‹œë“œì˜ 2% ì†ì‹¤ì„ ë³´ì¥í•©ë‹ˆë‹¤.
      </div>
    </div>
  </div>

  <div id="miniToast"></div>

  <script>
    // ===== ê³ ì •ê°’ =====
    const FIXED_SEED = 2000;
    const FIXED_LEV  = 100;

    // ===== iOS í‚¤ë³´ë“œ/ìŠ¤í¬ë¡¤ íŠ ì™„í™”: í¬ì»¤ìŠ¤ ì‹œ ê°€ìš´ë°ë¡œ ë¶€ë“œëŸ½ê²Œ ì •ë ¬ =====
    function attachIOSFocusFix() {
      const inputs = document.querySelectorAll('input:not([readonly])');
      inputs.forEach((el) => {
        el.addEventListener('focus', () => {
          setTimeout(() => {
            el.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }, 250);
        }, { passive: true });
      });
    }
    attachIOSFocusFix();

    // ===== í† ìŠ¤íŠ¸ =====
    let toastTimer = null;
    function showToast(msg) {
      const t = document.getElementById("miniToast");
      if (!t) return;
      t.textContent = msg;
      t.classList.add("show");
      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => t.classList.remove("show"), 1100);
    }

    // ===== í´ë¦½ë³´ë“œ ë³µì‚¬(HTTPSì—ì„œ ì•ˆì •ì , iOS fallback í¬í•¨) =====
    async function copyTextSafe(text) {
      const clean = String(text ?? "").trim();
      if (!clean) { showToast("ë³µì‚¬í•  ìˆ«ìê°€ ì—†ì–´ìš”"); return; }

      try {
        await navigator.clipboard.writeText(clean);
        showToast("âœ… ë³µì‚¬ë¨");
      } catch (e) {
        const dummy = document.createElement("textarea");
        dummy.value = clean;
        dummy.style.position = "fixed";
        dummy.style.opacity = "0";
        document.body.appendChild(dummy);
        dummy.focus();
        dummy.select();
        try { document.execCommand("copy"); } catch (_) {}
        document.body.removeChild(dummy);
        showToast("âœ… ë³µì‚¬ë¨");
      }
    }

    // ===== í™”ë©´ì— USDT/ì½¤ë§ˆê°€ ìˆì–´ë„ "ìˆ«ìë§Œ" ì¶”ì¶œ =====
    function extractFirstNumber(raw) {
      const s = String(raw ?? "");
      const m = s.replace(/[,\s]/g, "").match(/-?\d+(\.\d+)?/);
      return m ? m[0] : "";
    }

    // ===== ê²°ê³¼ ì˜ì—­ì˜ ìˆ«ì ì „ë¶€ íƒ­-ë³µì‚¬ í™œì„±í™” =====
    function enableTapToCopyAllResults() {
      const resultArea = document.getElementById("resultArea");
      if (!resultArea) return;

      const vals = resultArea.querySelectorAll(".res-val");
      vals.forEach((el) => {
        el.classList.add("copyable");

        if (el.dataset.bound === "1") return;
        el.addEventListener("click", () => {
          const num = extractFirstNumber(el.innerText || "");
          copyTextSafe(num);
        });
        el.dataset.bound = "1";
      });
    }

    // ===== í…”ë ˆê·¸ë¨ ë³µì‚¬ìš© í…ìŠ¤íŠ¸ ìƒì„± =====
    function buildTelegramText({ entries, stop, avgEntry, totalQty, totalSize, totalMargin, perQty, perSize, perMargin, totalRisk }) {
      const eText = entries.map((v, i) => `E${i+1}:${v}`).join(" / ");
      return [
        "ğŸ§® 3STEP POSITION",
        `Seed: ${FIXED_SEED} USDT | Lev: ${FIXED_LEV}x | Risk(2%): ${totalRisk.toFixed(2)} USDT`,
        `Entries: ${eText}`,
        `Stop: ${stop}`,
        `AvgEntry: ${avgEntry}`,
        `TotalQty: ${totalQty}`,
        `TotalSize: ${totalSize.toFixed(2)} USDT`,
        `TotalMargin: ${totalMargin.toFixed(2)} USDT`,
        `PerStep(${entries.length}): Qty ${perQty} | Size ${perSize.toFixed(2)} | Margin ${perMargin.toFixed(2)}`
      ].join("\n");
    }

    async function copyTelegramText() {
      const ta = document.getElementById("copyText");
      const status = document.getElementById("copyStatus");
      const text = (ta?.value || "").trim();

      if (!text) {
        status.innerText = "ë¨¼ì € ê³„ì‚°ì„ ì‹¤í–‰í•´ ì£¼ì„¸ìš”.";
        showToast("ë¨¼ì € ê³„ì‚°ì„ ì‹¤í–‰í•˜ì„¸ìš”");
        return;
      }

      try {
        await navigator.clipboard.writeText(text);
        status.innerText = "âœ… ë³µì‚¬ ì™„ë£Œ! í…”ë ˆê·¸ë¨ì— ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”.";
        showToast("âœ… ì „ì²´ í…ìŠ¤íŠ¸ ë³µì‚¬ë¨");
      } catch (e) {
        ta.focus();
        ta.select();
        ta.setSelectionRange(0, ta.value.length);
        status.innerText = "ë³µì‚¬ê°€ ë§‰í˜”ì–´ìš”. í…ìŠ¤íŠ¸ê°€ ì„ íƒëìœ¼ë‹ˆ â€˜ë³µì‚¬â€™ í›„ ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”.";
        showToast("ì„ íƒë¨ â†’ ë³µì‚¬í•˜ì„¸ìš”");
      }
    }

    // ===== ë©”ì¸ ê³„ì‚° =====
    function calculate() {
      const seed = FIXED_SEED;
      const lev  = FIXED_LEV;

      const stop = parseFloat(document.getElementById('stop').value);

      const entries = [
        parseFloat(document.getElementById('e1').value),
        parseFloat(document.getElementById('e2').value),
        parseFloat(document.getElementById('e3').value)
      ].filter(v => !isNaN(v) && v > 0);

      if (!stop || entries.length === 0) {
        alert("ì§„ì…ê°€(ìµœì†Œ 1ê°œ)ì™€ ì†ì ˆê°€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!");
        return;
      }

      const avgEntry = entries.reduce((a, b) => a + b, 0) / entries.length;
      const totalRisk = seed * 0.02;
      const priceDiff = Math.abs(avgEntry - stop);

      if (priceDiff === 0) {
        alert("ì§„ì…ê°€ì™€ ì†ì ˆê°€ê°€ ê°™ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }

      const totalQty = totalRisk / priceDiff;
      const totalSize = totalQty * avgEntry;
      const totalMargin = totalSize / lev;

      const perQty = totalQty / entries.length;
      const perSize = totalSize / entries.length;
      const perMargin = totalMargin / entries.length;

      // ===== ì§„ì…ê°€/ì†ì ˆê°€ ì¹© í‘œì‹œ (ê°ê° ê°œë³„ ë³µì‚¬) =====
      const chipE1 = document.getElementById("chipE1");
      const chipE2 = document.getElementById("chipE2");
      const chipE3 = document.getElementById("chipE3");
      const chipStop = document.getElementById("chipStop");

      const e1 = entries[0] ?? null;
      const e2 = entries[1] ?? null;
      const e3 = entries[2] ?? null;

      if (chipE1) { chipE1.style.display = e1 ? "inline-flex" : "none"; chipE1.innerText = `E1: ${e1 ?? "-"}`; }
      if (chipE2) { chipE2.style.display = e2 ? "inline-flex" : "none"; chipE2.innerText = `E2: ${e2 ?? "-"}`; }
      if (chipE3) { chipE3.style.display = e3 ? "inline-flex" : "none"; chipE3.innerText = `E3: ${e3 ?? "-"}`; }
      if (chipStop) { chipStop.innerText = `STOP: ${stop}`; }

      // ===== ê²°ê³¼ í…ìŠ¤íŠ¸ ëŒ€ì… =====
      document.getElementById('resRisk').innerText = totalRisk.toLocaleString(undefined, { maximumFractionDigits: 2 }) + " USDT";
      document.getElementById('resAvgEntry').innerText = avgEntry.toLocaleString(undefined, { maximumFractionDigits: 4 });
      document.getElementById('resTotalQty').innerText = totalQty.toLocaleString(undefined, { maximumFractionDigits: 4 });
      document.getElementById('resTotalSize').innerText = totalSize.toLocaleString(undefined, { maximumFractionDigits: 2 }) + " USDT";
      document.getElementById('resTotalMargin').innerText = totalMargin.toLocaleString(undefined, { maximumFractionDigits: 2 }) + " USDT";

      document.getElementById('splitCountText').innerText = entries.length + "íšŒ ë¶„í•  ì§„ì… ê°€ì´ë“œ (1íšŒë‹¹)";
      document.getElementById('resPerQty').innerText = perQty.toLocaleString(undefined, { maximumFractionDigits: 4 });
      document.getElementById('resPerSize').innerText = perSize.toLocaleString(undefined, { maximumFractionDigits: 2 }) + " USDT";
      document.getElementById('resPerMargin').innerText = perMargin.toLocaleString(undefined, { maximumFractionDigits: 2 }) + " USDT";

      // ===== í…”ë ˆê·¸ë¨ ë³µì‚¬ìš© í…ìŠ¤íŠ¸ ìƒì„± =====
      const tgText = buildTelegramText({
        entries,
        stop,
        avgEntry: Number(avgEntry.toFixed(4)),
        totalQty: Number(totalQty.toFixed(4)),
        totalSize,
        totalMargin,
        perQty: Number(perQty.toFixed(4)),
        perSize,
        perMargin,
        totalRisk
      });
      document.getElementById("copyText").value = tgText;
      document.getElementById("copyStatus").innerText = "ê³„ì‚° ê²°ê³¼ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.";

      // ===== ê²°ê³¼ í‘œì‹œ =====
      const resultArea = document.getElementById('resultArea');
      resultArea.style.display = "block";

      // ê²°ê³¼ ìˆ«ì ì „ë¶€ íƒ­-ë³µì‚¬ í™œì„±í™”
      enableTapToCopyAllResults();

      // ê²°ê³¼ ì˜ì—­ìœ¼ë¡œ ìŠ¤í¬ë¡¤
      setTimeout(() => {
        resultArea.scrollIntoView({ behavior: "smooth", block: "start" });
      }, 50);
    }
  </script>
</body>
</html>
